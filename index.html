<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Leashed Pet Care</title>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f3f4f6;
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    .card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 20px;
    }
    h1, h2, h3 { color: #1f2937; }
    .btn {
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      border: none;
      font-size: 16px;
      color: white;
    }
    .btn-blue { background: #3b82f6; }
    .btn-blue:hover, .btn-blue:active { background: #2563eb; }
    .btn-red { background: #ef4444; }
    .btn-red:hover, .btn-red:active { background: #dc2626; }
    .btn-yellow { background: #f59e0b; }
    .btn-yellow:hover, .btn-yellow:active { background: #d97706; }
    .btn-green { background: #10b981; }
    .btn-green:hover, .btn-green:active { background: #059669; }
    input, select, textarea {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      box-sizing: border-box;
    }
    .error { color: #ef4444; font-size: 14px; }
    .flex-between { display: flex; justify-content: space-between; align-items: center; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    ul { list-style: none; padding: 0; }
    li { padding: 10px 0; border-bottom: 1px solid #e5e7eb; }
    .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
    .tab { padding: 10px; cursor: pointer; border-bottom: 2px solid transparent; }
    .tab.active { border-bottom-color: #3b82f6; font-weight: bold; }
    @media (max-width: 768px) { .grid-2, .grid-3 { grid-template-columns: 1fr; } }
    .hidden { display: none; }
    #admin-calendar { max-height: 600px; overflow: auto; }
    #walker-calendar, #client-calendar { max-height: 400px; overflow: auto; }
    textarea { resize: vertical; max-height: 100px; }
    img.map { max-width: 100%; height: auto; }
    .mt-2 { margin-top: 8px; }
  </style>
</head>
<body>
  <div id="login" class="container">
    <div class="card">
      <h1>Leashed Pet Care Login</h1>
      <div id="login-error" class="error hidden"></div>
      <div>
        <label for="username">Username</label>
        <input id="username" type="text" placeholder="Enter username (e.g., admin)" required>
      </div>
      <div>
        <label for="password">Password</label>
        <input id="password" type="password" placeholder="Enter password (e.g., admin123)" required>
      </div>
      <button class="btn btn-blue" onclick="handleLogin()">Login</button>
      <button class="btn btn-yellow mt-2" onclick="showSection('reset-password')">Reset Password</button>
    </div>
  </div>
  <div id="reset-password" class="container hidden">
    <div class="card">
      <h1>Reset Password</h1>
      <div id="reset-error" class="error hidden"></div>
      <div>
        <label for="reset-username">Username</label>
        <input id="reset-username" type="text" placeholder="Enter username" required>
      </div>
      <div>
        <label for="reset-code">Reset Code</label>
        <input id="reset-code" type="text" placeholder="Enter reset code" required>
      </div>
      <div>
        <label for="new-password">New Password</label>
        <input id="new-password" type="password" placeholder="Enter new password" required>
      </div>
      <button class="btn btn-blue" onclick="completePasswordReset()">Submit</button>
      <button class="btn btn-red mt-2" onclick="showSection('login')">Cancel</button>
    </div>
  </div>
  <div id="admin" class="container hidden">
    <div class="flex-between">
      <h1>Admin Dashboard</h1>
      <button class="btn btn-red" onclick="handleLogout()">Logout</button>
    </div>
    <div class="grid-2">
      <div class="card">
        <h2>Create New User</h2>
        <div>
          <label for="new-firstname">First Name</label>
          <input id="new-firstname" type="text" placeholder="First Name" required>
        </div>
        <div>
          <label for="new-lastname">Last Name</label>
          <input id="new-lastname" type="text" placeholder="Last Name" required>
        </div>
        <div class="grid-2">
          <div>
            <label for="new-street-number">Street Number</label>
            <input id="new-street-number" type="text" placeholder="Street Number" required>
          </div>
          <div>
            <label for="new-street-address">Street Address</label>
            <input id="new-street-address" type="text" placeholder="Street Address" required>
          </div>
        </div>
        <div>
          <label for="new-address-line2">2nd Address Line</label>
          <input id="new-address-line2" type="text" placeholder="Apt, Suite, etc. (optional)">
        </div>
        <div class="grid-3">
          <div>
            <label for="new-city">City</label>
            <input id="new-city" type="text" placeholder="City" required>
          </div>
          <div>
            <label for="new-state">State</label>
            <input id="new-state" type="text" placeholder="State (e.g., CA)" required>
          </div>
          <div>
            <label for="new-zip">Zip Code</label>
            <input id="new-zip" type="text" placeholder="Zip Code" required>
          </div>
        </div>
        <div>
          <label for="new-username">Username</label>
          <input id="new-username" type="text" placeholder="Username" required>
        </div>
        <div>
          <label for="new-password">Password</label>
          <input id="new-password" type="password" placeholder="Password" required>
        </div>
        <div>
          <label for="new-role">Role</label>
          <select id="new-role">
            <option value="walker">Walker</option>
            <option value="client">Client</option>
          </select>
        </div>
        <div>
          <label>Preferred Contact Method</label>
          <div class="grid-3">
            <label><input type="checkbox" id="new-contact-text"> Text</label>
            <label><input type="checkbox" id="new-contact-email"> Email</label>
            <label><input type="checkbox" id="new-contact-voice"> Voice</label>
          </div>
        </div>
        <button class="btn btn-blue" onclick="createUser()">Create User</button>
      </div>
      <div class="card">
        <h2>Master Calendar</h2>
        <div id="admin-calendar" class="max-h-[600px] overflow-auto"></div>
        <button class="btn btn-green" onclick="exportCalendarData()">Export Calendar Data</button>
        <div class="mt-4">
          <label for="import-data">Import Calendar Data</label>
          <input id="import-data" type="file" accept=".json">
          <button class="btn btn-blue mt-2" onclick="importCalendarData()">Import</button>
        </div>
      </div>
    </div>
    <div class="card">
      <h2>Dispatch Services</h2>
      <ul id="admin-dispatch"></ul>
    </div>
    <div class="card">
      <h2>User Service History</h2>
      <select id="admin-user-select" onchange="renderAdminServiceHistory()">
        <option value="">Select User</option>
      </select>
      <ul id="admin-service-history"></ul>
    </div>
    <div class="card">
      <h2>Reports</h2>
      <ul id="admin-reports"></ul>
    </div>
  </div>
  <div id="walker" class="container hidden">
    <div class="flex-between">
      <h1>Walker Dashboard</h1>
      <button class="btn btn-red" onclick="handleLogout()">Logout</button>
    </div>
    <div class="tabs">
      <div class="tab active" data-tab="walker-schedule">Schedule</div>
      <div class="tab" data-tab="walker-profile">Profile</div>
      <div class="tab" data-tab="walker-history">Service History</div>
    </div>
    <div id="walker-schedule" class="tab-content">
      <div class="card">
        <h2>Available Services</h2>
        <ul id="walker-available-services"></ul>
      </div>
      <div class="card">
        <h2>Book a Service</h2>
        <div>
          <label for="walker-service-type">Service Type</label>
          <select id="walker-service-type">
            <option value="20 Minute Walk">20 Minute Walk</option>
            <option value="30 Minute Walk">30 Minute Walk</option>
            <option value="60 Minute Walk">60 Minute Walk</option>
            <option value="Pet Sitting @ Client’s Home">Pet Sitting @ Client’s Home</option>
            <option value="Overnight Boarding">Overnight Boarding</option>
          </select>
        </div>
        <div>
          <label for="walker-book-date">Preferred Date</label>
          <input id="walker-book-date" type="date" min="2025-07-26">
        </div>
        <div>
          <label for="walker-book-time">Preferred Time</label>
          <input id="walker-book-time" type="time">
        </div>
        <button class="btn btn-blue" onclick="submitWalkerBooking()">Book Service</button>
      </div>
      <div class="card">
        <h2>Your Schedules</h2>
        <div id="walker-calendar" class="max-h-[400px] overflow-auto"></div>
        <h3>Set Availability</h3>
        <div>
          <label for="walker-date">Date</label>
          <input id="walker-date" type="date" min="2025-07-26">
        </div>
        <div>
          <label for="walker-time">Time</label>
          <input id="walker-time" type="time">
        </div>
        <button class="btn btn-blue" onclick="setAvailability()">Set Availability</button>
        <ul id="walker-schedules"></ul>
      </div>
      <div class="card">
        <h2>Submit Report</h2>
        <select id="walker-report-schedule" class="mb-4">
          <option value="">Select Schedule</option>
        </select>
        <div class="grid-2">
          <label><input type="checkbox" id="walker-report-poop"> Poop</label>
          <label><input type="checkbox" id="walker-report-pee"> Pee</label>
        </div>
        <div>
          <label for="walker-report-notes">Notes (max 250 characters)</label>
          <textarea id="walker-report-notes" maxlength="250" placeholder="Enter walk notes"></textarea>
        </div>
        <div>
          <label for="walker-report-gps">GPS Coordinates</label>
          <input id="walker-report-gps" type="text" placeholder="e.g., 37.7749,-122.4194" readonly>
        </div>
        <button class="btn btn-green" onclick="startGpsTracking()">Start GPS Tracking</button>
        <button class="btn btn-red" onclick="endGpsTracking()">End GPS Tracking</button>
        <button class="btn btn-blue mt-2" onclick="submitWalkerReport()">Submit Report</button>
      </div>
    </div>
    <div id="walker-profile" class="tab-content hidden">
      <div class="card">
        <h2>Your Profile</h2>
        <div id="walker-profile-display"></div>
        <h3>Update Profile</h3>
        <div>
          <label for="walker-firstname">First Name</label>
          <input id="walker-firstname" type="text" placeholder="First Name">
        </div>
        <div>
          <label for="walker-lastname">Last Name</label>
          <input id="walker-lastname" type="text" placeholder="Last Name">
        </div>
        <div class="grid-2">
          <div>
            <label for="walker-street-number">Street Number</label>
            <input id="walker-street-number" type="text" placeholder="Street Number">
          </div>
          <div>
            <label for="walker-street-address">Street Address</label>
            <input id="walker-street-address" type="text" placeholder="Street Address">
          </div>
        </div>
        <div>
          <label for="walker-address-line2">2nd Address Line</label>
          <input id="walker-address-line2" type="text" placeholder="Apt, Suite, etc. (optional)">
        </div>
        <div class="grid-3">
          <div>
            <label for="walker-city">City</label>
            <input id="walker-city" type="text" placeholder="City">
          </div>
          <div>
            <label for="walker-state">State</label>
            <input id="walker-state" type="text" placeholder="State (e.g., CA)">
          </div>
          <div>
            <label for="walker-zip">Zip Code</label>
            <input id="walker-zip" type="text" placeholder="Zip Code">
          </div>
        </div>
        <div>
          <label>Preferred Contact Method</label>
          <div class="grid-3">
            <label><input type="checkbox" id="walker-contact-text"> Text</label>
            <label><input type="checkbox" id="walker-contact-email"> Email</label>
            <label><input type="checkbox" id="walker-contact-voice"> Voice</label>
          </div>
        </div>
        <button class="btn btn-blue" onclick="updateWalkerProfile()">Save Profile</button>
        <h3>Update Password</h3>
        <button class="btn btn-yellow" onclick="showSection('reset-password')">Request Password Reset</button>
      </div>
    </div>
    <div id="walker-history" class="tab-content hidden">
      <div class="card">
        <h2>Service History</h2>
        <ul id="walker-service-history"></ul>
      </div>
    </div>
  </div>
  <div id="client" class="container hidden">
    <div class="flex-between">
      <h1>Client Dashboard</h1>
      <button class="btn btn-red" onclick="handleLogout()">Logout</button>
    </div>
    <div class="tabs">
      <div class="tab active" data-tab="client-schedule">Schedule</div>
      <div class="tab" data-tab="client-profile">Profile</div>
      <div class="tab" data-tab="client-history">Service History</div>
    </div>
    <div id="client-schedule" class="tab-content">
      <div class="card">
        <h2>Book a Service</h2>
        <div>
          <label for="client-service-type">Service Type</label>
          <select id="client-service-type">
            <option value="20 Minute Walk">20 Minute Walk</option>
            <option value="30 Minute Walk">30 Minute Walk</option>
            <option value="60 Minute Walk">60 Minute Walk</option>
            <option value="Pet Sitting @ Client’s Home">Pet Sitting @ Client’s Home</option>
            <option value="Overnight Boarding">Overnight Boarding</option>
          </select>
        </div>
        <div>
          <label for="client-date">Date</label>
          <input id="client-date" type="date" min="2025-07-26">
        </div>
        <div>
          <label for="client-time">Time</label>
          <input id="client-time" type="time">
        </div>
        <button class="btn btn-blue" onclick="submitClientRequest()">Submit Request</button>
      </div>
      <div class="card">
        <h2>Your Schedules</h2>
        <div id="client-calendar" class="max-h-[400px] overflow-auto"></div>
        <ul id="client-schedules"></ul>
      </div>
    </div>
    <div id="client-profile" class="tab-content hidden">
      <div class="card">
        <h2>Your Profile</h2>
        <div id="client-profile-display"></div>
        <h3>Update Profile</h3>
        <div>
          <label for="client-firstname">First Name</label>
          <input id="client-firstname" type="text" placeholder="First Name">
        </div>
        <div>
          <label for="client-lastname">Last Name</label>
          <input id="client-lastname" type="text" placeholder="Last Name">
        </div>
        <div class="grid-2">
          <div>
            <label for="client-street-number">Street Number</label>
            <input id="client-street-number" type="text" placeholder="Street Number">
          </div>
          <div>
            <label for="client-street-address">Street Address</label>
            <input id="client-street-address" type="text" placeholder="Street Address">
          </div>
        </div>
        <div>
          <label for="client-address-line2">2nd Address Line</label>
          <input id="client-address-line2" type="text" placeholder="Apt, Suite, etc. (optional)">
        </div>
        <div class="grid-3">
          <div>
            <label for="client-city">City</label>
            <input id="client-city" type="text" placeholder="City">
          </div>
          <div>
            <label for="client-state">State</label>
            <input id="client-state" type="text" placeholder="State (e.g., CA)">
          </div>
          <div>
            <label for="client-zip">Zip Code</label>
            <input id="client-zip" type="text" placeholder="Zip Code">
          </div>
        </div>
        <div>
          <label>Preferred Contact Method</label>
          <div class="grid-3">
            <label><input type="checkbox" id="client-contact-text"> Text</label>
            <label><input type="checkbox" id="client-contact-email"> Email</label>
            <label><input type="checkbox" id="client-contact-voice"> Voice</label>
          </div>
        </div>
        <button class="btn btn-blue" onclick="updateClientProfile()">Save Profile</button>
        <h3>Update Password</h3>
        <button class="showSection('btn btn-yellow" onclick="reset-password')">Request Password Reset</button>
      </div>
    </div>
    <div id="client-history" class="tab-content hidden">
      <div class="card">
        <h2>Service History</h2>
        <ul id="client-service-history"></ul>
      </div>
    </div>
  </div>
  <script>
    const CALENDAR_DATA_URL = 'https://domesticengineer.github.io/Leashed_App/calendar-data.json';
    let calendarData = { events: [] };
    let currentUser = null;
    let gpsTracking = { start: null, end: null, active: false };

    function initializeData() {
      try {
        alert('Initializing app data...');
        const defaultData = {
          users: [
            {
              id: 'admin1',
              firstName: 'Admin',
              lastName: 'User',
              username: 'admin',
              password: btoa('admin123'),
              role: 'admin',
              address: { streetNumber: '', streetAddress: '', addressLine2: '', city: '', state: '', zip: '' },
              preferredContact: { text: false, email: true, voice: false }
            },
            {
              id: 'walker1',
              firstName: 'John',
              lastName: 'Doe',
              username: 'walker1',
              password: btoa('walker123'),
              role: 'walker',
              address: { streetNumber: '123', streetAddress: 'Elm St', addressLine2: '', city: 'Anytown', state: 'CA', zip: '12345' },
              preferredContact: { text: true, email: false, voice: false }
            },
            {
              id: 'client1',
              firstName: 'Jane',
              lastName: 'Smith',
              username: 'client1',
              password: btoa('client123'),
              role: 'client',
              address: { streetNumber: '456', streetAddress: 'Oak St', addressLine2: 'Apt 2B', city: 'Othertown', state: 'CA', zip: '67890' },
              preferredContact: { text: false, email: true, voice: false }
            }
          ],
          schedules: [],
          checkIns: [],
          reports: []
        };
        if (!localStorage.getItem('leashedData')) {
          localStorage.setItem('leashedData', JSON.stringify(defaultData));
          localStorage.setItem('calendarEvents', JSON.stringify([]));
          alert('Default data initialized');
        }
      } catch (e) {
        alert('Failed to initialize data');
        console.error('Init error:', e);
      }
    }

    function getData() {
      try {
        const data = localStorage.getItem('leashedData');
        if (!data) {
          alert('No data found, reinitializing');
          initializeData();
          return JSON.parse(localStorage.getItem('leashedData'));
        }
        return JSON.parse(data);
      } catch (e) {
        alert('Error loading data');
        console.error('Get data error:', e);
        return { users: [], schedules: [], checkIns: [], reports: [] };
      }
    }

    function saveData(data) {
      try {
        localStorage.setItem('leashedData', JSON.stringify(data));
      } catch (e) {
        alert('Error saving data');
        console.error('Save data error:', e);
      }
    }

    function showSection(sectionId) {
      try {
        ['login', 'reset-password', 'admin', 'walker', 'client'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.classList.toggle('hidden', id !== sectionId);
        });
      } catch (e) {
        alert('Error switching sections');
        console.error('Section error:', e);
      }
    }

    function handleLogin() {
      try {
        alert('Starting login process');
        const usernameEl = document.getElementById('username');
        const passwordEl = document.getElementById('password');
        const errorEl = document.getElementById('login-error');
        if (!usernameEl || !passwordEl || !errorEl) {
          alert('Login elements missing');
          return;
        }
        const username = usernameEl.value.trim();
        const password = passwordEl.value.trim();
        errorEl.classList.add('hidden');

        if (!username || !password) {
          errorEl.textContent = 'Please enter username and password';
          errorEl.classList.remove('hidden');
          alert('Login failed: Missing fields');
          return;
        }

        alert('Fetching user data...');
        const data = getData();
        const user = data.users.find(
          u => u.username.toLowerCase() === username.toLowerCase() && u.password === btoa(password)
        );

        if (user) {
          currentUser = user;
          usernameEl.value = '';
          passwordEl.value = '';
          alert('Login successful');
          if (user.role === 'admin') {
            showSection('admin');
            renderAdmin();
          } else if (user.role === 'walker') {
            showSection('walker');
            renderWalker();
          } else {
            showSection('client');
            renderClient();
          }
          loadCalendarData();
        } else {
          errorEl.textContent = 'Invalid username or password';
          errorEl.classList.remove('hidden');
          alert('Login failed: Invalid credentials');
        }
      } catch (e) {
        alert('Login error');
        console.error('Login error:', e);
        const errorEl = document.getElementById('login-error');
        if (errorEl) {
          errorEl.textContent = 'Login failed';
          errorEl.classList.remove('hidden');
        }
      }
    }

    function handleLogout() {
      try {
        currentUser = null;
        showSection('login');
        alert('Logged out');
      } catch (e) {
        alert('Error logging out');
        console.error('Logout error:', e);
      }
    }

    function generateResetCode() {
      try {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let code = '';
        for (let i = 0; i < 8; i++) {
          code += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        alert('Generated reset code: ' + code);
        return code;
      } catch (e) {
        alert('Failed to generate reset code');
        console.error('Code gen error:', e);
        return null;
      }
    }

    function requestPasswordReset() {
      try {
        alert('Starting password reset');
        const username = (document.getElementById('username')?.value.trim() || document.getElementById('reset-username')?.value.trim()) || '';
        if (!username) {
          alert('Please enter a username');
          return false;
        }
        const data = getData();
        const user = data.users.find(u => u.username.toLowerCase() === username.toLowerCase());
        if (!user) {
          alert('User not found');
          return false;
        }
        const code = generateResetCode();
        if (!code) {
          alert('Failed to generate reset code');
          return false;
        }
        localStorage.setItem(`resetCode_${user.id}`, JSON.stringify({ code, expires: Date.now() + 10 * 60 * 1000 }));
        alert(`Reset code for ${user.username}: ${code} (valid for 10 minutes)`);
        showSection('reset-password');
        const resetUserEl = document.getElementById('reset-username');
        if (resetUserEl) resetUserEl.value = username;
        return true;
      } catch (e) {
        alert('Error requesting password reset');
        console.error('Reset error:', e);
        return false;
      }
    }

    function completePasswordReset() {
      try {
        alert('Completing password reset');
        const usernameEl = document.getElementById('reset-username');
        const codeEl = document.getElementById('reset-code');
        const newPasswordEl = document.getElementById('new-password');
        const errorEl = document.getElementById('reset-error');
        if (!usernameEl || !codeEl || !newPasswordEl || !errorEl) {
          alert('Reset elements missing');
          return;
        }
        const username = usernameEl.value.trim();
        const code = codeEl.value.trim();
        const newPassword = newPasswordEl.value.trim();
        errorEl.classList.add('hidden');

        if (!username || !code || !newPassword) {
          errorEl.textContent = 'Please fill in all fields';
          errorEl.classList.remove('hidden');
          alert('Reset failed: Missing fields');
          return;
        }

        const data = getData();
        const user = data.users.find(u => u.username.toLowerCase() === username.toLowerCase());
        if (!user) {
          errorEl.textContent = 'User not found';
          errorEl.classList.remove('hidden');
          alert('Reset failed: User not found');
          return;
        }

        const resetData = JSON.parse(localStorage.getItem(`resetCode_${user.id}`) || '{}');
        if (!resetData.code || resetData.code !== code || Date.now() > resetData.expires) {
          errorEl.textContent = 'Invalid or expired reset code';
          errorEl.classList.remove('hidden');
          alert('Reset failed: Invalid or expired code');
          return;
        }

        user.password = btoa(newPassword');
        saveData(data);
        localStorage.removeItem(`resetCode_${user.id}`);
        alert('Password updated successfully');
        showSection('login');
        usernameEl.value = '';
        codeEl.value = '';
        newPasswordEl.value = '';
      } catch (e) {
        alert('Error completing password reset');
        console.error('Password reset error:', e);
        const errorEl = document.getElementById('reset-error');
        if (errorEl) {
          errorEl.textContent = 'Failed to reset password';
          errorEl.classList.remove('hidden');
        }
      }
    }

    function loadCalendarData() {
      try {
        alert('Loading calendar data...');
        const localEvents = JSON.parse(localStorage.getItem('calendarEvents') || '[]');
        calendarData.events = localEvents;
        fetch(CALENDAR_DATA_URL)
          .then(response => response.json())
          .then(data => {
            calendarData.events = [...data.events, ...localEvents];
            alert('Calendar data fetched successfully');
            renderCalendars();
          })
          .catch(e => {
            alert('Failed to fetch calendar data, using local events');
            console.error('Fetch calendar error:', e);
            renderCalendars();
          });
      } catch (e) {
        alert('Error loading calendar data');
        console.error('Calendar load error:', e);
        renderCalendars();
      }
    }

    function saveLocalEvent(event) {
      try {
        const localEvents = JSON.parse(localStorage.getItem('calendarEvents') || '[]');
        const existingEventIndex = localEvents.findIndex(e => e.id === event.id);
        if (existingEventIndex !== -1) {
          localEvents[existingEventIndex] = event;
        } else {
          localEvents.push(event);
        }
        localStorage.setItem('calendarEvents', JSON.stringify(localEvents));
      } catch (e) {
        alert('Error saving calendar event');
        console.error('Event save error:', e);
      }
    }

    function createUser() {
      try {
        alert('Creating user...');
        const firstNameEl = document.getElementById('new-firstname');
        const lastNameEl = document.getElementById('new-lastname');
        const streetNumberEl = document.getElementById('new-street-number');
        const streetAddressEl = document.getElementById('new-street-address');
        const addressLine2El = document.getElementById('new-address-line2');
        const cityEl = document.getElementById('new-city');
        const stateEl = document.getElementById('new-state');
        const zipEl = document.getElementById('new-zip');
        const usernameEl = document.getElementById('new-username');
        const passwordEl = document.getElementById('new-password');
        const roleEl = document.getElementById('new-role');
        const contactTextEl = document.getElementById('new-contact-text');
        const contactEmailEl = document.getElementById('new-contact-email');
        const contactVoiceEl = document.getElementById('new-contact-voice');
        if (!firstNameEl || !lastNameEl || !usernameEl || !passwordEl || !roleEl) {
          alert('User creation elements missing');
          return;
        }
        const firstName = firstNameEl.value.trim();
        const lastName = lastNameEl.value.trim();
        const streetNumber = streetNumberEl.value.trim();
        const streetAddress = streetAddressEl.value.trim();
        const addressLine2 = addressLine2El.value.trim();
        const city = cityEl.value.trim();
        const state = stateEl.value.trim();
        const zip = zipEl.value.trim();
        const username = usernameEl.value.trim();
        const password = passwordEl.value.trim();
        const role = roleEl.value;
        const contactText = contactTextEl.checked;
        const contactEmail = contactEmailEl.checked;
        const contactVoice = contactVoiceEl.checked;
        const data = getData();

        if (data.users.some(u => u.username.toLowerCase() === username.toLowerCase())) {
          alert('Username already exists');
          return;
        }

        data.users.push({
          id: `user${data.users.length + 1}`,
          firstName,
          lastName,
          address: { streetNumber, streetAddress, addressLine2, city, state, zip },
          username,
          password: btoa(password),
          role,
          preferredContact: { text: contactText, email: contactEmail, voice: contactVoice }
        });

        saveData(data);
        alert('User created successfully');
        firstNameEl.value = '';
        lastNameEl.value = '';
        streetNumberEl.value = '';
        streetAddressEl.value = '';
        addressLine2El.value = '';
        cityEl.value = '';
        stateEl.value = '';
        zipEl.value = '';
        usernameEl.value = '';
        passwordEl.value = '';
        contactTextEl.checked = false;
        contactEmailEl.checked = false;
        contactVoiceEl.checked = false;
        renderAdmin();
      } catch (e) {
        alert('Error creating user');
        console.error('Create user error:', e);
      }
    }

    function submitClientRequest() {
      try {
        alert('Submitting client request...');
        const serviceTypeEl = document.getElementById('client-service-type');
        const dateEl = document.getElementById('client-date');
        const timeEl = document.getElementById('client-time');
        if (!serviceTypeEl || !dateEl || !timeEl) {
          alert('Request elements missing');
          return;
        }
        const serviceType = serviceTypeEl.value;
        const date = dateEl.value;
        const time = timeEl.value;
        if (!date || !time) {
          alert('Please select a date and time');
          return;
        }
        const start = `${date}T${time}:00`;
        const end = new Date(start);
        end.setHours(end.getHours() + 1);
        const data = getData();
        const scheduleId = `sch${data.schedules.length + 1}`;
        data.schedules.push({
          id: scheduleId,
          clientId: currentUser.id,
          walkerId: null,
          pet: 'Pet',
          serviceType,
          date,
          time,
          status: 'pending',
          paymentStatus: 'unpaid'
        });
        const event = {
          id: `event${Date.now()}`,
          title: `Requested: ${serviceType}`,
          start,
          end: end.toISOString(),
          advocateId: null,
          clientId: currentUser.id,
          status: 'pending',
          public: true
        };
        saveLocalEvent(event);
        saveData(data);
        alert('Request submitted');
        serviceTypeEl.value = '20 Minute Walk';
        dateEl.value = '';
        timeEl.value = '';
        renderClient();
      } catch (e) {
        alert('Error submitting request');
        console.error('Client request error:', e);
      }
    }

    function submitWalkerBooking() {
      try {
        alert('Submitting walker booking...');
        const serviceTypeEl = document.getElementById('walker-service-type');
        const dateEl = document.getElementById('walker-book-date');
        const timeEl = document.getElementById('walker-book-time');
        if (!serviceTypeEl || !dateEl || !timeEl) {
          alert('Booking elements missing');
          return;
        }
        const serviceType = serviceTypeEl.value;
        const date = dateEl.value;
        const time = timeEl.value;
        if (!date || !time) {
          alert('Please select a date and time');
          return;
        }
        const start = `${date}T${time}:00`;
        const end = new Date(start);
        end.setHours(end.getHours() + 1);
        const data = getData();
        const scheduleId = `sch${data.schedules.length + 1}`;
        data.schedules.push({
          id: scheduleId,
          clientId: null,
          walkerId: currentUser.id,
          pet: 'TBD',
          serviceType,
          date,
          time,
          status: 'pending',
          paymentStatus: 'unpaid'
        });
        const event = {
          id: `event${Date.now()}`,
          title: `Requested: ${serviceType}`,
          start,
          end: end.toISOString(),
          advocateId: currentUser.id,
          clientId: null,
          status: 'pending',
          public: false
        };
        saveLocalEvent(event);
        saveData(data);
        alert('Booking submitted');
        serviceTypeEl.value = '20 Minute Walk';
        dateEl.value = '';
        timeEl.value = '';
        renderWalker();
      } catch (e) {
        alert('Error submitting booking');
        console.error('Walker booking error:', e);
      }
    }

    function acceptService(scheduleId) {
      try {
        alert('Accepting service...');
        const data = getData();
        const schedule = data.schedules.find(s => s.id === scheduleId);
        if (!schedule) {
          alert('Schedule not found');
          return;
        }
        schedule.walkerId = currentUser.id;
        schedule.status = 'booked';
        const event = calendarData.events.find(e => e.id === schedule.id || (e.clientId === schedule.clientId && e.start.includes(schedule.date)));
        if (event) {
          event.advocateId = currentUser.id;
          event.status = 'booked';
          event.title = `Booked: ${schedule.serviceType}`;
          saveLocalEvent(event);
        }
        saveData(data);
        alert('Service accepted');
        renderWalker();
      } catch (e) {
        alert('Error accepting service');
        console.error('Accept service error:', e);
      }
    }

    function assignService(scheduleId, walkerId) {
      try {
        alert('Assigning service...');
        const data = getData();
        const schedule = data.schedules.find(s => s.id === scheduleId);
        if (!schedule) {
          alert('Schedule not found');
          return;
        }
        schedule.walkerId = walkerId;
        schedule.status = 'booked';
        const event = calendarData.events.find(e => e.id === scheduleId || (e.clientId === schedule.clientId && e.start.includes(schedule.date)));
        if (event) {
          event.advocateId = walkerId;
          event.status = 'booked';
          event.title = `Booked: ${schedule.serviceType}`;
          saveLocalEvent(event);
        }
        saveData(data);
        alert('Service assigned');
        renderAdmin();
      } catch (e) {
        alert('Error assigning service');
        console.error('Assign service error:', e);
      }
    }

    function setAvailability() {
      try {
        alert('Setting availability...');
        const dateEl = document.getElementById('walker-date');
        const timeEl = document.getElementById('walker-time');
        if (!dateEl || !timeEl) {
          alert('Availability elements missing');
          return;
        }
        const date = dateEl.value;
        const time = timeEl.value;
        if (!date || !time) {
          alert('Please select a date and time');
          return;
        }
        const start = `${date}T${time}:00`;
        const end = new Date(start);
        end.setHours(end.getHours() + 1);
        const event = {
          id: `event${Date.now()}`,
          title: 'Available Slot',
          start,
          end: end.toISOString(),
          advocateId: currentUser.id,
          clientId: null,
          status: 'available',
          public: true
        };
        saveLocalEvent(event);
        alert('Availability set');
        dateEl.value = '';
        timeEl.value = '';
        renderWalker();
      } catch (e) {
        error('Error setting availability');
        console.error('Availability error:', e);
      }
    }

    function startGpsTracking() {
      try {
        alert('Starting GPS tracking...');
        if (gpsTracking.activeElements) {
          alert('GPS tracking already active elements');
          return;
        }
        navigator.geolocation.getCurrentPosition(
          pos => {
            gpsTracking.startTime = `${pos.coords.latitude},${pos.coords.longitude}`;
            gpsTracking.activeElements = true;
            const gpsEl = document.getElementById('walker-report-gps');
            if (gpsEl) gpsEl.value = gpsTracking.startTime;
            alert('GPS tracking started successfully');
          },
          e => alert('GPS access denied: ' + e.message)
        );
      } catch (e) {
        alert('Error starting GPS tracking');
        console.error('GPS start error:', e.g);
      }
    }

    function endGpsTracking() {
      try {
        alert('Ending GPS tracking');
        if (!gpsTracking.activeElements)) {
          alert('No active GPS tracking elements');
          return;
        }
        navigator.geolocation.getCurrentPosition(
          pos => {
            gpsTracking.endTime = `${pos.coords.latitude},${pos.coords.longitude}`;
            gpsTracking.activeElements = false;
            const gpsEl = document.getElementById('walker-report-gps');
            if (gpsEl) gpsEl.value = gpsTracking.endTime;
            alert('GPS tracking ended successfully');
          },
          e => alert('GPS access denied: ' + e.message)
        );
      } catch (e) {
        alert('Error ending GPS tracking');
        console.error('GPS end error:', e.g);
      }
    }

    function submitWalkerReport() {
      try {
        alert('Submitting walker report...');
        const scheduleEl = document.getElementById('walker-report-schedule');
        const poopEl = document.getElementById('walker-report-po');
        const peeEl = document.getElementById('walker-report-pee');
        const notesEl = document.getElementById('walker-report-notes');
        const gpsEl = document.getElementById('walker-report-gps');
        if (!scheduleEl || !poopEl || !peeEl || !pnotesEl || !gpsEl) {
          alert('Report elements missing');
          return;
        }
        const scheduleId = scheduleEl.value;
        const poop = poopEl.checked;
        const pee = peeEl.checked;
        const notes = notesEl.value;
        const gps = gpsTracking.endTime || gpsEl.value;
        if (!scheduleId) {
          alert('Please select a schedule');
          return;
        }
        const data = getData();
        const schedule = data.schedules.find(s => s.id === scheduleId);
        if (!schedule) {
          alert('Schedule not found');
          return;
        }
        const startTime = new Date().toISOString();
        const endTime = new Date().toISOString();
        const report = {
          id: `rep${data.reports.length + 1}`,
          scheduleId,
          walkerId: currentUser.id,
          startTime,
          endTime,
          poop,
          pee,
          notes,
          gpsStart: gpsTracking.start,
          gpsEnd: gps,
          timestamp: new Date().toISOString()
        };
        data.reports.push(report);
        schedule.status = 'completed';
        saveData(data);
        alert('Report submitted successfully');
        gpsTracking = { start: null, endTime: null, active: false };
        scheduleEl.value = '';
        poopEl.checked = false;
        peeEl.checked = false;
        notesEl.value = '';
        gpsEl.value = '';
        renderWalker();
      } catch (e) {
        alert('Error submitting report');
        console.error('Report error:', e);
      }
    }

    function updateWalkerProfile() {
      try {
        alert('Updating walker profile...');
        const data = getData();
        const user = data.users.find(u => u.id === currentUser.id);
        if (!user) {
          alert('User not found');
          return;
        }
        const firstNameEl = document.getElementById('walker-firstname');
        const lastNameEl = document.getElementById('walker-lastname');
        const streetNumberEl = document.getElementById('walker-street-number');
        const streetAddressEl = document.getElementById('walker-address-address');
        const addressLine2El = document.getElementById('walker-address-line2');
        const cityEl = document.getElementById('walker-city');
        const stateEl = document.getElementById('walker-state');
        const zipEl = document.getElementById('walker-zip');
        const contactTextEl = document.getElementById('walker-contact-text');
        const contactEmailEl = document.getElementById('walker-contact-email');
        const contactVoiceEl = document.getElementById('walker-contact-voice');
        if (!firstNameEl || !lastNameEl) {
          alert('Profile elements missing');
          return;
        }
        user.firstName = firstNameEl.value;
        user.lastName = lastNameEl.value;
        user.address.streetNumber = streetNumberEl?.value || '';
        user.address.streetAddress = streetAddressEl?.value || '';
        user.addressLine2.addressLine2 = addressLine2El?.value || '';
        user.address.city = cityEl?.value || '';
        user.address.state = stateEl?.value || '';
        user.address.zip = zipEl?.value || '';
        user.preferredContact.text = contactTextEl?.checked || false;
        user.preferredContact.email = contactEmailEl?.checked || false;
        user.preferredContactVoice = contactVoiceEl?.preferredContact || false;
        saveData(data);
        alert('Profile updated successfully');
        renderWalker();
      } catch (e) {
        alert('Error updating profile');
        console.error('Walker profile error:', e);
      }
    }

    function updateClientProfile() {
      try {
        alert('Updating client profile...');
        const data = getData();
        const user = data.users.find(u => u.id === currentUser.id);
        if (!user) {
          alert('User not found');
          return;
        }
        const firstNameEl = document.getElementById('client-firstname');
        const lastNameEl = document.getElementById('client-lastname');
        const streetNumberEl = document.getElementById('client-street-number');
        const streetAddressEl = document.getElementById('client-address-address');
        const addressLine2El = document.getElementById('client-address-line2');
        const cityEl = document.getElementById('client-city');
        const stateEl = document.getElementById('client-state-id');
        const zipEl = document.getElementById('zip-id');
        const contactTextEl = contact.getElementById('contact-id');
        const contactEmailEl = contact.getElementById('contact-email');
        const contactVoiceEl = contact.getElementById('contact-id');
        if (!firstName || !lastNameEl) {
          alert('Profile elements missing');
          return;
        }
        user.firstName = firstNameEl?.value || '';
        user.lastName = lastNameEl?.value || '';
        user.address.streetNumber = streetNumberEl?.value || '';
        user.streetAddress.streetNumber = streetAddressEl?.streetAddress || '';
        user.addressLine2.address = addressLine2El?.addressLine2 || '';
        user.address.city = cityEl?.value || '';
        user.address.state = stateEl?.value || '';
        user.address.zip = zipEl?.value || '';
        user.preferredContact.text = contactTextEl?.checked || false;
        user.preferredContact.email = contactEmailEl?.checked || false;
        user.preferredContactVoice = contactVoiceEl?.preferredContact || false;
        saveData(data);
        alert('Profile updated successfully');
        renderClient();
      } catch (e) {
        alert('Error updating profile');
        console.error('Client profile error:', e);
      }
    }

    function updatePaymentStatus(scheduleId, status) {
      try {
        alert('Updating payment status...');
        const data = getData();
        const schedule = data.schedules.find(s => s.id === scheduleId);
        if (!schedule) {
          alert('Schedule not found');
          return;
        }
        schedule.paymentStatus = status;
        saveData(data);
        renderAdminService();
      } catch (e) {
        alert('Error updating payment status');
        console.error('Payment status:', e);
      }
    }

    function exportCalendarData() {
      try {
        alert('Exporting calendar data...');
        const eventData = JSON.parse(localStorage.getItem('calendarEvents') || '[]');
        const blobData = new Blob([JSON.stringify({ events: eventData }, null, 2)], { type: 'application/json' });
        const url = URL.createObject(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'calendar-data.json';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObject(url);
      } catch (e) {
        alert('Error exporting calendar data');
        console.error('Export error:', e);
      }
    }

    function importCalendarData() {
      try {
        alert('Importing calendar data...');
        const fileInput = document.getElementById('import-data');
        const fileData = fileInput?.files?.[0];
        if (!fileData) {
          alert('Please select a file');
          return;
        }
        const reader = new FileReader();
        reader.onload = function(e) => {
          try {
            const importedEvents = JSON.parse(e.target.result);
            localStorage.setItem('calendarEvents', JSON.stringify(importedData.events));
            loadCalendarData();
            alert('Calendar data imported successfully');
            renderCalendars();
          } catch (e) {
            alert('Invalid JSON data');
            console.error('Import parse error:', e);
          }
        };
        reader.readAsText(fileData);
      } catch (e) {
        alert('Error importing calendar data');
        console.error('Import error:', e);
      }
    }

    function renderCalendars() {
      try {
        alert('Rendering calendars...');
        if (typeof window.FullCalendar === 'undefined') {
          alert('Calendar library not loaded; calendars disabled');
          return;
        }
        if (currentUser.role === 'admin') {
          const calendarEl = document.getElementById('admin-calendar');
          if (calendarEl) {
            const calendar = new FullCalendar.Calendar(calendarEl, {
              initialView: 'timeGridWeek',
              events: calendarData.events || [],
              eventColor: '#ef4444',
              headerToolbar: { left: 'prev,next', center: 'title', right: 'timeGridWeek,dayGridMonth' },
              slotMinTime: '08:00:00',
              slotMaxTime: '20:00:00',
              height: '600px',
              'eventClick: function(info) {
                if (confirm(`Delete event ${info.event.title}?`)) {
                  calendarData.events = calendarData.events.filter(e => e.id !== info.event.id);
                  localStorage.setItem('calendarEvents', JSON.stringify(calendarData.events));
                  calendar.refetchEvents();
                }
              }
            });
            calendar.render();
            alert('Admin calendar rendered');
          }
        } else if (currentUser.role === 'walker') {
          const calendarEl = document.getElementById('walker-calendar');
          if (calendarEl) {
            const calendar = new FullCalendar.Calendar(calendarEl, {
              initialView: 'timeGridWeek',
              events: calendarData.events.filter(e => e.advocateId === currentUser.id || e.idstatus === 'pending'),
              eventColor: '#3b82f6',
              headerToolbar: { left: 'prev,next', center: 'title', right: 'timeGridWeek,timeGridDayMonth' },
              slotMinTime: '08:00:00',
              slotMaxTime: '20:00:00',
              height: '400px'
            });
            calendar.render();
            alert('Walker calendar rendered successfully');
          }
        } else {
          const calendarEl = document.getElementById('client-calendar');
          if (calendarEl) {
            const calendar = new FullCalendar.Calendar(calendarEl, {
              initialView: 'timeGridWeek',
              events: calendarData.events.filter(e => e.clientId === currentUser.id || e.idstatus === 'pending'),
              eventColor: '#10b981',
              headerToolbar: { left: 'prev,next', center: 'title', right: 'timeGridWeek,dayGridMonth' },
              slotMinTime: '08:00:00',
              slotMaxTime: '20:00:00',
              height: '400px'
            });
            calendar.render();
            alert('Client calendar rendered successfully');
          }
        }
      } catch (e) {
        alert('Error rendering calendars');
        console.error('Calendar render error:', e);
      }
    }

    function renderAdmin() {
      try {
        alert('Rendering admin dashboard...');
        const data = getData();
        const userSelectEl = document.getElementById('admin-user-select');
        const dispatchListEl = document.getElementById('admin-listdispatch');
        const reportsListEl = document.getElementById('admin-listreports');
        if (!userSelectEl || !dispatchListEl || !reportsListEl) {
          alert('Admin dashboard elements missing');
          return;
        }
        userSelectEl.innerHTML = '<option value="">Select User</option>';
        dispatchListEl.innerHTML = '';
        reportsListEl.innerHTML = '';

        data.users.forEach(u => {
          userSelectEl.innerHTML += `<option value="${u.id}">${u.firstName} ${u.lastName} (${u.username})</option>`;
        });

        users.forEach(s => {
          const unassignedSchedules = data.schedules.filter(s => !s.walkerId && s.schedulestatus === 'pending');
        unassignedSchedulesList.forEach(s => {
          const walkerOptionsList = data.users
            .filter(u => u.roleid === 'walker')
            .map(u => `<option value="${u.id}">${u.firstName} ${u.lastName}</option>`)
            .join('');
          dispatchListEl.innerHTML += `
            <li class="flex-between">
              <span class="">Service: ${s.serviceType}, Date: ${s.date}, Time: ${s.time}, Client: ${data.users.find(u => u.id === s.clientId)?.firstName || 'Website'}</span>
              <div>
                <select id="dispatch_${s.id}">
                  <option value="">Select Walker</option>
                  ${walkerOptions}
                </select>
                <button class="btn btn-blue" onclick="assignService('${s.id}', document.getElementById('dispatch_${s.id}').value)">Assign</button>
              </div>
            </li>
          `;
        });

        data.reportsList.forEach(r => {
          const schedule = data.schedules.find(s => s.id === r.scheduleId);
          reportsListEl.innerHTML += `
            <li>Service: ${schedule?.serviceType || 'Unknown'}, Start: ${r.startTime}, End: ${r.endTime}, Poop: ${r.poop}, Contact: ${r.notes}, '</li>
            `;
        });
        renderAdminService();
        alert('Admin dashboard rendered successfully');
      } catch (e) {
        alert('Error rendering admin dashboard');
        console.error('Admin render error:', error);
      }
    }

    function renderAdminServiceHistory() {
      try {
        alert('Rendering service history...');
        const userSelectEl = document.getElementById('user-select');
        const historyListEl = document.getElementById('service-history');
        if (!userSelectEl || !historyListEl) {
          alert('Service history elements missing');
          return;
        }
        const userId = userSelectEl.value;
        historyListEl.innerHTML = '';
        if (!userId) historyList.innerHTML = ''; return;
        const data = getData();
        const schedulesList = data.schedules.filter(s => s.clientId === userId || s.idwalkerId === userId);
        schedulesList.forEach(s => {
          const reportList = data.reports.find(r => r.scheduleId === s.id);
          const paymentStatusOptions = s.paymentStatus === 'paid'
            ? '<option value="paid" selected>Paid</option><option value="unpaid">Unpaid</option>'
            : '<option value="paid">Paid</option><option value="unpaid" selected>Unpaid</option>';
          historyListEl.innerHTML += `
            <li>
              Service: ${s.serviceType}, Date: ${s.date}, Time: ${s.time}, Status: ${s.idstatus}, Payment: 
              <select onchange="updatePaymentStatus('${s.id}', this.value)">${paymentOptions}</select>
              ${report ? `<br>Start: ${report.startTime}, End: ${report.endTime}, Poop: ${report.poop}, Pee: ${report.peeTime}, Notes: ${report.notes}, GPS: ${report.gpsStart} to ${report.gpsEnd}` : ''}'
            </li>
          `;
        });
        alert('Service history rendered successfully');
      } catch (e) {
        alert('Error rendering service history');
        console.error('History render error:', e);
      }
    }

    function renderWalker() {
      try {
        alert('Rendering walker dashboard...');
        const data = getData();
        const schedulesListEl = document.getElementById('walker-list-schedules');
        const availableServicesListEl = document.getElementById('walker-services-services');
        const reportSelectEl = document.getElementById('walker-report-id-schedule');
        const profileDisplayElEl = document.getElementById('walker-display-profile');
        if (!schedulesListEl || !availableServicesListEl || !reportSelectEl || !profileDisplayElEl) {
          alert('Walker dashboard elements missing');
          return;
        }
        schedulesListEl.innerHTML = '';
        availableServicesListEl.innerHTML = '';
        reportSelectEl.innerHTML = '<option value="">Select Schedule</option>';

        const schedulesList = data.schedules.filter(s => s.walkerId === currentUser.id);
        schedulesList.forEach(s => {
          let scheduleButtons = '';
          if (s.status !== 'completed') {
            scheduleButtons = `
              <input type="text" id="gps_${s.id}" placeholder="Enter GPS (e.g., 37.7749,-122.4194)">
              <button class="btn btn-green" onclick="handleCheckInOut('${s.id}', 'check-in', document.getElementById('gps_${s.id}').value)" ${s.status === 'in-progress' ? 'disabled' : ''}>Check-In</button>
              <button class="btn btn-yellow" onclick="handleCheckInOut('${s.id}', 'check-out', document.getElementById('gps_${s.id}').value)" ${s.status !== 'in-progress' ? 'disabled' : ''}>Check-Out</button>
            `;
          }
          schedulesListEl.innerHTML += `
            <li class="flex-between">
              <span>Pet: ${s.pet}, Schedule: ${s.serviceType}, Date: ${s.date}, Time: ${s.time}, Status: ${s.status}</span>
              <div>${scheduleButtons}</div>
            </li>
          `;
          if (s.status !== 'completed') {
            reportSelectEl.innerHTML += `<option value="${s.id}">${s.serviceType} on ${s.date} at ${s.time}</option>`;
          }
        });

        const availableSchedulesList = data.schedules.filter(s => !s.idwalkerId && s.idstatus === 'pending');
        availableSchedulesList.forEach(s => {
          availableServicesList.innerHTML += `
            <li class="flex-between">
              <span>Service:/installer ${s.serviceType}, Date: ${s.date}, Time: ${s.time}, Client: ${data.users.find(u => u.id === s.clientId)?.firstName || 'Website'}</span>
              <button class="btn btn-blue" onclick="acceptService('${s.id}')">Accept</button>
            </li>
          `;
        });

        profileDisplayEl.innerHTML = `
          <p><strong>Name:</strong> ${currentUser.firstName} ${currentUser.lastName}</p>
          <p><strong>Address:</strong> ${currentUser.address.streetNumber} ${currentUser.address.streetAddress}${currentUser.address.addressLine2 ? ', ' + currentUser.address.addressLine2 : ''}, ${currentUser.address.city}, ${currentUser.address.state} ${currentUser.address.zip}</p>
          <p><strong>Contact:</strong> ${Object.keys(currentUser.preferredContact).filter(k => currentUser.preferredContact[k]).join(', ') || 'None'}</p>
        `;
        const firstNameEl = document.getElementById('walker-firstname');
        const lastNameEl = document.getElementById('walker-lastname');
        const streetNumberEl = document.getElementById('walker-street-number');
        const streetAddressEl = document.getElementById('walker-street-address');
        const addressLine2El = document.getElementById('walker-address-line2');
        const cityEl = document.getElementById('walker-address-line2');
        const stateEl = document.getElementById('walker-state');
        const zipEl = document.getElementById('walker-zip');
        const contactTextEl = document.getElementById('walker-contact-text');
        const contactEmailEl = document.getElementById('walker-contact-email');
        const contactVoiceEl = document.getElementById('walker-contact-voice');
        if (firstNameEl) firstNameEl.value = currentUser.firstName;
        if (lastNameEl) lastNameEl.value = currentUser.lastName;
        if (streetNumberEl) streetNumberEl.value = currentUser.address.streetNumber;
        if (streetAddressEl) streetAddressEl.value = currentUser.address.streetAddress;
        if (addressLine2El) addressLine2El.value = currentUser.addressLine2.address;
        if (cityEl) cityEl.value = currentUser.address.city;
        if (stateEl) stateEl.value = currentUser.address.state;
        if (zipEl) zipEl.value = currentUser.address.zip;
        if (contactTextEl) contactTextEl.checked = currentUser.preferredContact.text;
        if (contactEmailEl) contactEmailEl.checked = currentUser.preferredContact.email;
        if (contactVoiceEl) contactVoiceEl.checked = currentUser.preferredContact.voice;

        const serviceHistoryEl = document.getElementById('walker-service-history');
        if (historyListEl) {
          historyListEl.innerHTML = '';
          schedules.filter(s => {
            const reportList = data.reports.find(r => r.scheduleId === s.id);
            historyListEl.innerHTML += `
              <li>
                Service: ${s.serviceType}, Date: ${s.date}, Time: ${s.time}, Status: ${s.status}, Payment: ${s.paymentStatus}
                ${report ? `<br>Start: ${report.startTime}, End: ${report.endTime}, Poop: ${report.poop}, Pee: ${report.peeTime}, Notes: ${report.notes}, GPS: ${report.gpsStart} to ${report.gpsEnd}` : ''}`
              </li>
            `;
          });
        }

        const tabs = document.querySelectorAll('#walker .tab');
        tabs.forEach(tab => {
          tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#walker .tab-content').forEach(t => t.classList.add('hidden'));
            tab.classList.add('active');
            const tabContentEl = document.getElementById(tab.dataset.tab);
            if (tabContentEl) tabContentEl.classList.remove('hidden');
          });
        });

        renderCalendars();
        alert('Walker dashboard rendered successfully');
      } catch (e) {
        alert('Error rendering walker dashboard');
        console.error('Walker render error:', e);
      }
    }

    function renderClient() {
      try {
        alert('Rendering client dashboard...');
        const data = getData();
        const clientSchedulesEl = document.getElementById('client-schedules');
        const profileDisplayEl = document.getElementById('client-display-profile');
        if (!clientSchedulesEl || !profileDisplayEl) {
          alert('Client dashboard elements missing');
          return;
        }
        clientSchedulesEl.innerHTML = '';

        const clientSchedules = data.schedules.filter(s => s.clientId === currentUser.id);
        clientSchedules.forEach(schedule => {
          clientSchedulesEl.innerHTML += `<li>${schedule.pet}, Service: ${s.serviceType}, Schedule: ${s.date}, Status: ${s.time}, Payment: ${s.paymentStatus}</li>`;
        });

        profileDisplayEl.innerHTML = `
          <p><strong>Name:</strong> ${currentUser.firstName} ${currentUser.lastName}</p>
          <p><strong>Address:</strong> ${currentUser.address.streetNumber} ${currentUser.address.streetAddress}${currentUser.address.addressLine2 ? ', ' + currentUser.address.addressLine2 : ''}, ${currentUser.address.city}, ${currentUser.address.state} ${currentUser.address.zip}</p>
          <p><strong>Contact:</strong> ${Object.keys(currentUser.preferredContact).filter(k => currentUser.preferredContact[k]).join(', ') || 'None'}</p>
        `;
        const firstNameEl = document.getElementById('client-firstname');
        const lastNameEl = document.getElementById('client-lastname');
        const streetNumberEl = document.getElementById('client-street-number');
        const streetAddressEl = document.getElementById('client-street-address');
        const addressLine2El = document.getElementById('client-address-line2');
        const cityEl = document.getElementById('client-city');
        const stateEl = document.getElementById('client-state');
        const zipEl = document.getElementById('client-zip');
        const contactTextEl = document.getElementById('client-contact-text');
        const contactEmailEl = document.getElementById('client-contact-email');
        const contactVoiceEl = document.getElementById('client-contact-voice');
        if (firstNameEl) firstNameEl.value = currentUser.firstName;
        if (lastNameEl) lastNameEl.value = currentUser.lastName;
        if (streetNumberEl) streetNumberEl.value = currentUser.address.streetNumber;
        if (streetAddressEl) streetAddressEl.value = currentUser.address.streetAddress;
        if (addressLine2El) addressLine2El.value = currentUser.addressLine2.address;
        if (cityEl) cityEl.value = currentUser.address.city;
        if (stateEl) stateEl.value = currentUser.address.state;
        if (zipEl) zipEl.value = currentUser.address.zip;
        if (contactTextEl) contactText.checked = currentUser.preferredContact.text;
        if (contactEmailEl) contactEmailEl.checked = currentUser.emailContact.email;
        if (contactVoiceEl) contactVoiceEl.checked = currentUser.preferredVoiceContact.voice;

        const serviceHistoryEl = document.getElementById('client-service-history');
        if (historyEl) {
          historyEl.innerHTML = '';
          schedules.forEach(s => {
            const reportList = data.reports.find(r => r.id === s.id);
            historyEl.innerHTML += `
              <li>
                Service: ${s.serviceType}, Schedule: ${s.date}, Time: ${s.time}, Status: ${s.status}, Payment: ${s.paymentStatus}
                ${report ? `<br>Start time: ${report.startTime}, End time: ${report.endTime}, Poop: ${report.poop}, Pee: ${report.peeTime}, Notes: ${report.notes}, GPS: ${report.gpsStart} to ${report.gpsEnd}` : ''}`
              </li>
            `;
          });
        }

        const tabs = document.querySelectorAll('#client .tab');
        tabs.forEach(tab => {
          tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#client .tab-content').forEach(c => {
              c.classList.add('hidden');
            });
            tab.classList.add('active');
            const tabContentEl = document.getElementById(tab.dataset.tab);
            if (tabContentEl) tabContentEl.classList.remove('hidden');
          });
        });

        renderCalendars();
        alert('Client dashboard rendered successfully');
      } catch (e) {
        alert('Error rendering client dashboard');
        console.error('Client render error:', e);
      }
    }

    function handleCheckInOut(scheduleId, action, gpsId) {
      try {
        alert(`Processing ${action}...`);
        const data = getData();
        const timestamp = new Date().toISOString();
        data.checkIns.push({
          id: `check${data.checkIns.length + 1}`,
          scheduleId,
          action,
          gps,
          timestamp,
        });
        const schedule = data.schedules.find(s => s.id === scheduleId);
        if (schedule) {
          schedule.status = action === 'check-in' ? 'in-progress' : 'completed';
        }
        saveData(data);
        alert('Check-in/out processed successfully');
        renderWalker();
      } catch (e) {
        alert('Error processing check-in/out');
        console.error('Check-in error:', e);
      }
    }

    // Initialize data events
    initializeData();
  </script>
</body>
</html>
```

### Why This Should Resolve the Error
-
