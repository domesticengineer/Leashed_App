<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Leashed Pet Care</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f3f4f6;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 400px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 { color: #1f2937; text-align: center; }
    .error { color: #ef4444; font-size: 14px; text-align: center; }
    input {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      box-sizing: border-box;
    }
    .btn {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      color: white;
    }
    .btn-blue { background: #3b82f6; }
    .btn-blue:hover, .btn-blue:active { background: #2563eb; }
    .btn-yellow { background: #f59e0b; }
    .btn-yellow:hover, .btn-yellow:active { background: #d97706; }
    .btn-red { background: #ef4444; }
    .btn-red:hover, .btn-red:active { background: #dc2626; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div id="login" class="container">
    <h1>Leashed Pet Care Login</h1>
    <div id="login-error" class="error hidden"></div>
    <input id="username" type="text" placeholder="Enter username (e.g., admin)" required>
    <input id="password" type="password" placeholder="Enter password (e.g., admin123)" required>
    <button class="btn btn-blue" onclick="handleLogin()">Login</button>
    <button class="btn btn-yellow" onclick="showSection('reset-password')">Reset Password</button>
  </div>
  <div id="reset-password" class="container hidden">
    <h1>Reset Password</h1>
    <div id="reset-error" class="error hidden"></div>
    <input id="reset-username" type="text" placeholder="Enter username" required>
    <input id="reset-code" type="text" placeholder="Enter reset code" required>
    <input id="new-password" type="password" placeholder="Enter new password" required>
    <button class="btn btn-blue" onclick="completePasswordReset()">Submit</button>
    <button class="btn btn-red" onclick="showSection('login')">Cancel</button>
  </div>
  <div id="dashboard" class="container hidden">
    <h1>Welcome, <span id="user-name"></span></h1>
    <p>Role: <span id="user-role"></span></p>
    <button class="btn btn-red" onclick="handleLogout()">Logout</button>
  </div>
  <script>
    let currentUser = null;

    function initializeData() {
      alert('Initializing app data...');
      const defaultData = {
        users: [
          {
            id: 'admin1',
            username: 'admin',
            password: btoa('admin123'),
            role: 'admin',
            firstName: 'Admin'
          },
          {
            id: 'walker1',
            username: 'walker1',
            password: btoa('walker123'),
            role: 'walker',
            firstName: 'John'
          },
          {
            id: 'client1',
            username: 'client1',
            password: btoa('client123'),
            role: 'client',
            firstName: 'Jane'
          }
        ]
      };
      try {
        if (!localStorage.getItem('leashedData')) {
          localStorage.setItem('leashedData', JSON.stringify(defaultData));
          alert('Default users created: admin/admin123, walker1/walker123, client1/client123');
        } else {
          alert('Data already initialized');
        }
      } catch (err) {
        alert('Failed to initialize data. Clear browser storage and reload.');
        console.error('Init error:', err);
      }
    }

    function getData() {
      try {
        const data = localStorage.getItem('leashedData');
        if (!data) {
          alert('No data found, reinitializing');
          initializeData();
          return JSON.parse(localStorage.getItem('leashedData'));
        }
        return JSON.parse(data);
      } catch (err) {
        alert('Error loading data. Clear browser storage and reload.');
        console.error('Get data error:', err);
        return { users: [] };
      }
    }

    function saveData(data) {
      try {
        localStorage.setItem('leashedData', JSON.stringify(data));
        alert('Data saved successfully');
      } catch (err) {
        alert('Failed to save data');
        console.error('Save data error:', err);
      }
    }

    function generateResetCode() {
      try {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let code = '';
        for (let i = 0; i < 8; i++) {
          code += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        alert('Generated reset code: ' + code);
        return code;
      } catch (err) {
        alert('Failed to generate reset code');
        console.error('Code gen error:', err);
        return null;
      }
    }

    function showSection(sectionId) {
      ['login', 'reset-password', 'dashboard'].forEach(id => {
        document.getElementById(id).classList.toggle('hidden', id !== sectionId);
      });
    }

    function handleLogin() {
      alert('Starting login process');
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();
      const errorEl = document.getElementById('login-error');
      errorEl.classList.add('hidden');

      if (!username || !password) {
        errorEl.textContent = 'Please enter username and password';
        errorEl.classList.remove('hidden');
        alert('Login failed: Missing username or password');
        return;
      }

      alert('Fetching user data');
      const data = getData();
      const user = data.users.find(
        u => u.username.toLowerCase() === username.toLowerCase() && u.password === btoa(password)
      );

      if (user) {
        currentUser = user;
        document.getElementById('user-name').textContent = user.firstName;
        document.getElementById('user-role').textContent = user.role;
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
        alert('Login successful for ' + user.username);
        showSection('dashboard');
      } else {
        errorEl.textContent = 'Invalid username or password';
        errorEl.classList.remove('hidden');
        alert('Login failed: Invalid credentials');
      }
    }

    function requestPasswordReset() {
      alert('Starting password reset');
      const username = document.getElementById('username').value || document.getElementById('reset-username').value;
      if (!username) {
        alert('Please enter a username');
        return;
      }
      const data = getData();
      const user = data.users.find(u => u.username.toLowerCase() === username.toLowerCase());
      if (!user) {
        alert('User not found');
        return;
      }
      const code = generateResetCode();
      if (!code) {
        alert('Failed to generate reset code');
        return;
      }
      try {
        localStorage.setItem(`resetCode_${user.id}`, JSON.stringify({ code, expires: Date.now() + 10 * 60 * 1000 }));
        alert(`Reset code: ${code} (valid for 10 minutes)`);
        showSection('reset-password');
        document.getElementById('reset-username').value = username;
      } catch (err) {
        alert('Failed to save reset code');
        console.error('Reset code save error:', err);
      }
    }

    function completePasswordReset() {
      alert('Completing password reset');
      const username = document.getElementById('reset-username').value;
      const code = document.getElementById('reset-code').value;
      const newPassword = document.getElementById('new-password').value;
      const errorEl = document.getElementById('reset-error');
      errorEl.classList.add('hidden');

      if (!username || !code || !newPassword) {
        errorEl.textContent = 'Please fill in all fields';
        errorEl.classList.remove('hidden');
        alert('Reset failed: Missing fields');
        return;
      }

      const data = getData();
      const user = data.users.find(u => u.username.toLowerCase() === username.toLowerCase());
      if (!user) {
        errorEl.textContent = 'User not found';
        errorEl.classList.remove('hidden');
        alert('Reset failed: User not found');
        return;
      }

      const resetData = JSON.parse(localStorage.getItem(`resetCode_${user.id}`) || '{}');
      if (!resetData.code || resetData.code !== code || Date.now() > resetData.expires) {
        errorEl.textContent = 'Invalid or expired reset code';
        errorEl.classList.remove('hidden');
        alert('Reset failed: Invalid or expired code');
        return;
      }

      user.password = btoa(newPassword);
      saveData(data);
      localStorage.removeItem(`resetCode_${user.id}`);
      alert('Password updated successfully');
      showSection('login');
      document.getElementById('reset-username').value = '';
      document.getElementById('reset-code').value = '';
      document.getElementById('new-password').value = '';
    }

    function handleLogout() {
      currentUser = null;
      showSection('login');
      alert('Logged out');
    }

    // Initialize app
    initializeData();
  </script>
</body>
</html>
