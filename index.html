<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Leashed Pet Care</title>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f3f4f6;
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    .card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 20px;
    }
    h1, h2 { color: #1f2937; }
    .btn {
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      border: none;
      font-size: 16px;
    }
    .btn-blue { background: #3b82f6; color: white; }
    .btn-blue:hover { background: #2563eb; }
    .btn-red { background: #ef4444; color: white; }
    .btn-red:hover { background: #dc2626; }
    .btn-green { background: #10b981; color: white; }
    .btn-green:hover { background: #059669; }
    input, select {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      box-sizing: border-box;
    }
    .error { color: #ef4444; font-size: 14px; }
    .flex-between { display: flex; justify-content: space-between; align-items: center; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    ul { list-style: none; padding: 0; }
    li { padding: 10px 0; border-bottom: 1px solid #e5e7eb; }
    @media (max-width: 768px) { .grid-2 { grid-template-columns: 1fr; } }
    .hidden { display: none; }
    #client-calendar { max-height: 200px; overflow: auto; }
  </style>
</head>
<body>
  <div id="login" class="container">
    <div class="card">
      <h1>Leashed Pet Care Login</h1>
      <div id="login-error" class="error hidden"></div>
      <div>
        <label for="username">Username</label>
        <input id="username" type="text" placeholder="Enter username" required>
      </div>
      <div>
        <label for="password">Password</label>
        <input id="password" type="password" placeholder="Enter password" required>
      </div>
      <button class="btn btn-blue" onclick="handleLogin()">Login</button>
    </div>
  </div>
  <div id="admin" class="container hidden">
    <div class="flex-between">
      <h1>Admin Dashboard</h1>
      <button class="btn btn-red" onclick="handleLogout()">Logout</button>
    </div>
    <div class="grid-2">
      <div class="card">
        <h2>Create New User</h2>
        <div>
          <label for="new-firstname">First Name</label>
          <input id="new-firstname" type="text" placeholder="First Name" required>
        </div>
        <div>
          <label for="new-lastname">Last Name</label>
          <input id="new-lastname" type="text" placeholder="Last Name" required>
        </div>
        <div>
          <label for="new-username">Username</label>
          <input id="new-username" type="text" placeholder="Username" required>
        </div>
        <div>
          <label for="new-password">Password</label>
          <input id="new-password" type="password" placeholder="Password" required>
        </div>
        <div>
          <label for="new-role">Role</label>
          <select id="new-role">
            <option value="walker">Walker</option>
            <option value="client">Client</option>
          </select>
        </div>
        <button class="btn btn-blue" onclick="createUser()">Create User</button>
      </div>
      <div class="card">
        <h2>Master Calendar</h2>
        <div id="admin-calendar" class="max-h-[200px] overflow-auto"></div>
        <button class="btn btn-green" onclick="exportCalendarData()">Export Calendar Data</button>
        <div class="mt-4">
          <label for="import-data">Import Calendar Data</label>
          <input id="import-data" type="file" accept=".json">
          <button class="btn btn-blue mt-2" onclick="importCalendarData()">Import</button>
        </div>
      </div>
    </div>
    <div class="card">
      <h2>Reports</h2>
      <ul id="admin-reports"></ul>
    </div>
  </div>
  <div id="walker" class="container hidden">
    <div class="flex-between">
      <h1>Walker Dashboard</h1>
      <button class="btn btn-red" onclick="handleLogout()">Logout</button>
    </div>
    <div class="card">
      <h2>Your Schedules</h2>
      <div id="walker-calendar" class="max-h-[200px] overflow-auto"></div>
      <h3>Set Availability</h3>
      <div>
        <label for="walker-date">Date</label>
        <input id="walker-date" type="date" min="2025-07-26">
      </div>
      <div>
        <label for="walker-time">Time</label>
        <input id="walker-time" type="time">
      </div>
      <button class="btn btn-blue" onclick="setAvailability()">Set Availability</button>
      <ul id="walker-schedules"></ul>
    </div>
    <div class="card">
      <h2>Your Reports</h2>
      <ul id="walker-reports"></ul>
    </div>
  </div>
  <div id="client" class="container hidden">
    <div class="flex-between">
      <h1>Client Dashboard</h1>
      <button class="btn btn-red" onclick="handleLogout()">Logout</button>
    </div>
    <div class="card">
      <h2>Book a Service</h2>
      <div>
        <label for="client-service-type">Service Type</label>
        <select id="client-service-type">
          <option value="Walk">Walk</option>
          <option value="Grooming">Grooming</option>
          <option value="Boarding">Boarding</option>
          <option value="Training">Training</option>
        </select>
      </div>
      <div>
        <label for="client-date">Preferred Date</label>
        <input id="client-date" type="date" min="2025-07-26">
      </div>
      <div>
        <label for="client-time">Preferred Time</label>
        <input id="client-time" type="time">
      </div>
      <button class="btn btn-blue" onclick="submitClientRequest()">Book Service</button>
    </div>
    <div class="card">
      <h2>Your Schedules</h2>
      <div id="client-calendar" class="max-h-[200px] overflow-auto"></div>
      <ul id="client-schedules"></ul>
    </div>
    <div class="card">
      <h2>Reports</h2>
      <ul id="client-reports"></ul>
    </div>
    <div class="card">
      <button class="btn btn-blue" onclick="alert('Payment functionality not implemented')">Pay Now</button>
    </div>
  </div>
  <script>
    const CALENDAR_DATA_URL = 'https://domesticengineer.github.io/Leashed_App_Pro/calendar-data.json';
    let calendarData = { events: [] };
    let currentUser = null;

    function initializeData() {
      const defaultData = {
        users: [
          { id: 'admin1', firstName: 'Admin', lastName: 'User', username: 'admin', password: btoa('admin123'), role: 'admin' },
          { id: 'walker1', firstName: 'John', lastName: 'Doe', username: 'walker1', password: btoa('walker123'), role: 'walker' },
          { id: 'client1', firstName: 'Jane', lastName: 'Smith', username: 'client1', password: btoa('client123'), role: 'client' },
        ],
        schedules: [
          { id: 'sch1', clientId: 'client1', walkerId: 'walker1', pet: 'Buddy', date: '2025-07-25', time: '10:00', status: 'pending' },
        ],
        checkIns: [],
        reports: [],
      };
      if (!localStorage.getItem('leashedData')) {
        localStorage.setItem('leashedData', JSON.stringify(defaultData));
      }
      if (!localStorage.getItem('calendarEvents')) {
        localStorage.setItem('calendarEvents', JSON.stringify([]));
      }
    }

    function getData() {
      return JSON.parse(localStorage.getItem('leashedData') || '{}');
    }

    function saveData(data) {
      localStorage.setItem('leashedData', JSON.stringify(data));
    }

    function loadCalendarData() {
      fetch(CALENDAR_DATA_URL)
        .then(response => response.json())
        .then(data => {
          calendarData = data;
          const localEvents = JSON.parse(localStorage.getItem('calendarEvents') || '[]');
          calendarData.events = [...calendarData.events, ...localEvents];
          renderCalendars();
        })
        .catch(() => {
          calendarData.events = JSON.parse(localStorage.getItem('calendarEvents') || '[]');
          renderCalendars();
        });
    }

    function saveLocalEvent(event) {
      const localEvents = JSON.parse(localStorage.getItem('calendarEvents') || '[]');
      localEvents.push(event);
      localStorage.setItem('calendarEvents', JSON.stringify(localEvents));
      console.log(`Reminder trigger: ${event.status} ${event.id} for ${event.start}`);
      fetch('YOUR_ZAPIER_WEBHOOK_URL', {
        method: 'POST',
        body: JSON.stringify(event)
      }).catch(err => console.error('Webhook failed:', err));
    }

    function handleLogin() {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const data = getData();
      const user = data.users.find(
        u => u.username.toLowerCase() === username.toLowerCase() && u.password === btoa(password)
      );
      if (user) {
        currentUser = user;
        document.getElementById('login-error').classList.add('hidden');
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
        if (user.role === 'admin') {
          showSection('admin');
        } else if (user.role === 'walker') {
          showSection('walker');
        } else {
          showSection('client');
        }
        loadCalendarData();
      } else {
        document.getElementById('login-error').textContent = 'Invalid username or password';
        document.getElementById('login-error').classList.remove('hidden');
      }
    }

    function handleLogout() {
      currentUser = null;
      showSection('login');
    }

    function showSection(sectionId) {
      ['login', 'admin', 'walker', 'client'].forEach(id => {
        document.getElementById(id).classList.toggle('hidden', id !== sectionId);
      });
    }

    function createUser() {
      const firstName = document.getElementById('new-firstname').value;
      const lastName = document.getElementById('new-lastname').value;
      const username = document.getElementById('new-username').value;
      const password = document.getElementById('new-password').value;
      const role = document.getElementById('new-role').value;
      const data = getData();

      if (data.users.some(u => u.username.toLowerCase() === username.toLowerCase())) {
        alert('Username already exists');
        return;
      }

      data.users.push({
        id: `user${data.users.length + 1}`,
        firstName,
        lastName,
        username,
        password: btoa(password),
        role
      });

      saveData(data);
      document.getElementById('new-firstname').value = '';
      document.getElementById('new-lastname').value = '';
      document.getElementById('new-username').value = '';
      document.getElementById('new-password').value = '';
      alert('User created successfully');
      renderAdmin();
    }

    function createSchedule() {
      const clientId = document.getElementById('schedule-client').value;
      const walkerId = document.getElementById('schedule-walker').value;
      const pet = document.getElementById('pet').value;
      const date = document.getElementById('schedule-date').value;
      const time = document.getElementById('schedule-time').value;
      const data = getData();

      data.schedules.push({
        id: `sch${data.schedules.length + 1}`,
        clientId,
        walkerId,
        pet,
        date,
        time,
        status: 'pending'
      });

      const event = {
        id: `event${Date.now()}`,
        title: `Booked: Walk for ${pet}`,
        start: `${date}T${time}:00`,
        end: new Date(`${date}T${time}:00`).setHours(new Date(`${date}T${time}:00`).getHours() + 1).toISOString(),
        advocateId: walkerId,
        clientId,
        status: 'booked',
        public: false,
      };
      saveLocalEvent(event);
      saveData(data);
      document.getElementById('schedule-client').value = '';
      document.getElementById('schedule-walker').value = '';
      document.getElementById('pet').value = '';
      document.getElementById('schedule-date').value = '';
      document.getElementById('schedule-time').value = '';
      alert('Schedule created successfully');
      renderAdmin();
    }

    function handleCheckInOut(scheduleId, action, gps) {
      const data = getData();
      const timestamp = new Date().toISOString();
      data.checkIns.push({
        id: `check${data.checkIns.length + 1}`,
        scheduleId,
        action,
        gps,
        timestamp
      });
      const schedule = data.schedules.find(s => s.id === scheduleId);
      schedule.status = action === 'check-in' ? 'in-progress' : 'completed';
      data.reports.push({
        id: `rep${data.reports.length + 1}`,
        scheduleId,
        text: `Walker ${currentUser.username} ${action} for ${schedule.pet}`,
        timestamp
      });
      const event = calendarData.events.find(e => e.advocateId === schedule.walkerId && e.clientId === schedule.clientId && e.start.includes(schedule.date));
      if (event) event.status = schedule.status;
      saveLocalEvent(event);
      saveData(data);
      alert(`${action} recorded`);
      renderWalker();
    }

    function submitClientRequest() {
      const serviceType = document.getElementById('client-service-type').value;
      const date = document.getElementById('client-date').value;
      const time = document.getElementById('client-time').value;
      if (!date || !time) {
        alert('Please select a date and time');
        return;
      }
      const start = `${date}T${time}:00`;
      const end = new Date(start);
      end.setHours(end.getHours() + 1);
      const event = {
        id: `event${Date.now()}`,
        title: `Requested: ${serviceType}`,
        start,
        end: end.toISOString(),
        advocateId: null,
        clientId: currentUser.id,
        status: 'pending',
        public: false,
      };
      saveLocalEvent(event);
      alert('Booking submitted! Awaiting confirmation.');
      document.getElementById('client-service-type').value = 'Walk';
      document.getElementById('client-date').value = '';
      document.getElementById('client-time').value = '';
      renderClient();
    }

    function setAvailability() {
      const date = document.getElementById('walker-date').value;
      const time = document.getElementById('walker-time').value;
      if (!date || !time) {
        alert('Please select a date and time');
        return;
      }
      const start = `${date}T${time}:00`;
      const end = new Date(start);
      end.setHours(end.getHours() + 1);
      const event = {
        id: `event${Date.now()}`,
        title: 'Available Slot',
        start,
        end: end.toISOString(),
        advocateId: currentUser.id,
        clientId: null,
        status: 'available',
        public: true,
      };
      saveLocalEvent(event);
      alert('Availability set');
      document.getElementById('walker-date').value = '';
      document.getElementById('walker-time').value = '';
      renderWalker();
    }

    function exportCalendarData() {
      try {
        const localEvents = JSON.parse(localStorage.getItem('calendarEvents') || '[]');
        const blob = new Blob([JSON.stringify({ events: localEvents }, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'calendar-data.json';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      } catch (error) {
        alert('Failed to export calendar data: ' + error.message);
      }
    }

    function importCalendarData() {
      const fileInput = document.getElementById('import-data');
      const file = fileInput.files[0];
      if (!file) {
        alert('Please select a file');
        return;
      }
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const importedData = JSON.parse(e.target.result);
          localStorage.setItem('calendarEvents', JSON.stringify(importedData.events));
          loadCalendarData();
          alert('Calendar data imported successfully');
        } catch (err) {
          alert('Invalid JSON data');
        }
      };
      reader.readAsText(file);
    }

    function renderCalendars() {
      if (currentUser.role === 'admin') {
        const calendarEl = document.getElementById('admin-calendar');
        const calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: 'timeGridWeek',
          events: calendarData.events,
          eventColor: '#ef4444',
          headerToolbar: { left: 'prev,next', center: 'title', right: 'timeGridWeek,dayGridMonth' },
          slotMinTime: '08:00:00',
          slotMaxTime: '20:00:00',
          height: '200px',
          eventClick: function(info) {
            if (confirm(`Delete event ${info.event.title}?`)) {
              calendarData.events = calendarData.events.filter(e => e.id !== info.event.id);
              localStorage.setItem('calendarEvents', JSON.stringify(calendarData.events));
              calendar.refetchEvents();
            }
          },
        });
        calendar.render();
      } else if (currentUser.role === 'walker') {
        const calendarEl = document.getElementById('walker-calendar');
        const calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: 'timeGridWeek',
          events: calendarData.events.filter(e => e.advocateId === currentUser.id),
          eventColor: '#3b82f6',
          headerToolbar: { left: 'prev,next', center: 'title', right: 'timeGridWeek,dayGridMonth' },
          slotMinTime: '08:00:00',
          slotMaxTime: '20:00:00',
          height: '200px',
        });
        calendar.render();
      } else {
        const calendarEl = document.getElementById('client-calendar');
        const calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: 'timeGridWeek',
          events: calendarData.events.filter(e => e.clientId === currentUser.id || e.status === 'pending'),
          eventColor: '#10b981',
          headerToolbar: { left: 'prev,next', center: 'title', right: 'timeGridWeek,dayGridMonth' },
          slotMinTime: '08:00:00',
          slotMaxTime: '20:00:00',
          height: '200px',
        });
        calendar.render();
      }
    }

    function renderAdmin() {
      const data = getData();
      const clientSelect = document.getElementById('schedule-client');
      const walkerSelect = document.getElementById('schedule-walker');
      const reportsList = document.getElementById('admin-reports');
      clientSelect.innerHTML = '<option value="">Select Client</option>';
      walkerSelect.innerHTML = '<option value="">Select Walker</option>';
      reportsList.innerHTML = '';

      data.users.filter(u => u.role === 'client').forEach(u => {
        clientSelect.innerHTML += `<option value="${u.id}">${u.firstName} ${u.lastName} (${u.username})</option>`;
      });
      data.users.filter(u => u.role === 'walker').forEach(u => {
        walkerSelect.innerHTML += `<option value="${u.id}">${u.firstName} ${u.lastName} (${u.username})</option>`;
      });

      data.reports.forEach(r => {
        reportsList.innerHTML += `<li>${r.text} (Time: ${r.timestamp})</li>`;
      });
    }

    function renderWalker() {
      const data = getData();
      const schedulesList = document.getElementById('walker-schedules');
      const reportsList = document.getElementById('walker-reports');
      schedulesList.innerHTML = '';
      reportsList.innerHTML = '';

      const schedules = data.schedules.filter(s => s.walkerId === currentUser.id);
      schedules.forEach(s => {
        let buttons = '';
        if (s.status !== 'completed') {
          buttons = `
            <input type="text" id="gps-${s.id}" placeholder="Enter mock GPS (e.g., 37.7749,-122.4194)">
            <button class="btn btn-green" onclick="handleCheckInOut('${s.id}', 'check-in', document.getElementById('gps-${s.id}').value)" ${s.status === 'in-progress' ? 'disabled' : ''}>Check-In</button>
            <button class="btn btn-yellow" onclick="handleCheckInOut('${s.id}', 'check-out', document.getElementById('gps-${s.id}').value)" ${s.status !== 'in-progress' ? 'disabled' : ''}>Check-Out</button>
          `;
        }
        schedulesList.innerHTML += `
          <li class="flex-between">
            <span>Pet: ${s.pet}, Date: ${s.date}, Time: ${s.time}, Status: ${s.status}</span>
            <div>${buttons}</div>
          </li>
        `;
      });

      data.reports.filter(r => schedules.some(s => s.id === r.scheduleId)).forEach(r => {
        reportsList.innerHTML += `<li>${r.text} (Time: ${r.timestamp})</li>`;
      });
      renderCalendars();
    }

    function renderClient() {
      const data = getData();
      const schedulesList = document.getElementById('client-schedules');
      const reportsList = document.getElementById('client-reports');
      schedulesList.innerHTML = '';
      reportsList.innerHTML = '';

      const schedules = data.schedules.filter(s => s.clientId === currentUser.id);
      schedules.forEach(s => {
        schedulesList.innerHTML += `<li>Pet: ${s.pet}, Date: ${s.date}, Time: ${s.time}, Status: ${s.status}</li>`;
      });

      data.reports.filter(r => schedules.some(s => s.id === r.scheduleId)).forEach(r => {
        reportsList.innerHTML += `<li>${r.text} (Time: ${r.timestamp})</li>`;
      });
      renderCalendars();
    }

    initializeData();
    showSection('login');
  </script>
</body>
</html>
